
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Evan Flynn">
      
      
        <link rel="canonical" href="https://ros-realtime.github.io/reference-system/main/Files/reference__system_2reference__system__py_2benchmark_8py/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.12">
    
    
      
        <title>reference_system/reference_system_py/benchmark.py - Reference System Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.27ad92d8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reference_systemreference_system_pybenchmarkpy" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        <aside class="md-banner md-banner--warning">
          
        </aside>
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Reference System Documentation" class="md-header__button md-logo" aria-label="Reference System Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Reference System Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              reference_system/reference_system_py/benchmark.py
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ros-realtime/reference-system.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Reference System Documentation" class="md-nav__button md-logo" aria-label="Reference System Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Reference System Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ros-realtime/reference-system.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Pages/md_README" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Reports" class="md-nav__link">
        Reports
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Classes" class="md-nav__link">
        Classes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Namespaces" class="md-nav__link">
        Namespaces
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Modules" class="md-nav__link">
        Modules
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Files
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Pages" class="md-nav__link">
        Related Pages
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#namespaces" class="md-nav__link">
    Namespaces
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#source-code" class="md-nav__link">
    Source code
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/ros-realtime/reference-system.git/edit/master/docs/Files/reference__system_2reference__system__py_2benchmark_8py.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="reference_systemreference_system_pybenchmarkpy">reference_system/reference_system_py/benchmark.py</h1>
<h2 id="namespaces">Namespaces</h2>
<table>
<thead>
<tr>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong><a href="/reference-system/Namespaces/namespacereference__system__py/">reference_system_py</a></strong></td>
</tr>
<tr>
<td><strong><a href="/reference-system/Namespaces/namespacereference__system__py_1_1benchmark/">reference_system_py::benchmark</a></strong></td>
</tr>
</tbody>
</table>
<h2 id="source-code">Source code</h2>
<pre><code class="language-python">#!/usr/bin/env python3
# Copyright 2021 Apex.AI, Inc.
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Generates traces for specified executables and RMWs

import contextlib
import fcntl
import os
from pathlib import Path
import subprocess
import time

from ament_index_python import get_package_prefix

from bokeh.io import output_file as bokeh_output_file
from bokeh.layouts import layout as bokeh_layout
from bokeh.plotting import save as bokeh_save

import psutil

from . import callback_duration
from . import dropped_messages
from . import memory_usage
from . import std_latency
from .constants import SIZE_SUBPLOT, SIZE_SUMMARY


try:
    from tracetools_trace.tools.names import DEFAULT_EVENTS_ROS
    from trace_utils import initDataModel
    tracetools_available = True
except ModuleNotFoundError:
    tracetools_available = False


ROS_HOME = Path(os.environ.get('ROS_HOME', os.environ['HOME']+'/.ros'))


def available_executables(pkg, pattern='*'):
    prefix = get_package_prefix(pkg)
    return [path.stem for path in (Path(prefix)/'lib'/pkg).glob(pattern)]


def get_benchmark_directory(base_directory, executable, runtime_sec, rmw, create=False):
    &quot;&quot;&quot;
    Return the directory to place measurements and reports for the given experiment.

    If `create` is True, the directory is created if it does not exist yet.
    &quot;&quot;&quot;
    # Note: memory_usage.py and std_latency.py make assumptions about the directory format.
    # Do not change this without also changing these other files.
    directory = Path(base_directory)/f'{runtime_sec}s/{rmw}/{executable}/'
    if create:
        directory.mkdir(parents=True, exist_ok=True)
    return directory


def get_benchmark_directories_below(base_directory, runtime_sec=None):
    &quot;&quot;&quot;Return all benchmark directories found below `base_directory`.&quot;&quot;&quot;
    runtime_re = '*[0-9]' if runtime_sec is None else str(runtime_sec)
    return [str(directory) for directory in Path(base_directory).glob(f'*{runtime_re}s/rmw_*/*')]


@contextlib.contextmanager
def terminatingRos2Run(pkg, executable, rmw, env=os.environ, args=[], **kwargs):
    &quot;&quot;&quot;
    Run the given executable (part of the given package) under the given rmw.

    The executable is automatically terminated upon exit from the context
    &quot;&quot;&quot;
    env = env.copy()
    env['RCUTILS_CONSOLE_OUTPUT_FORMAT'] = '[{severity}] [{name}]: {message}'
    env['RMW_IMPLEMENTATION'] = rmw
    env['RCL_ASSERT_RMW_ID_MATCHES'] = rmw

    assert 'timeout' not in kwargs, ('terminatingRos2Run does not support the timeout argument;' +
                                     'use time.sleep in the with block instead')

    ros_executable = Path(get_package_prefix(pkg))/'lib'/pkg/executable
    cmdline = f'{ros_executable} {&quot; &quot;.join(args)}'
    process = subprocess.Popen(cmdline,
                               shell=True,
                               env=env,
                               **kwargs)
    shellproc = psutil.Process(process.pid)
    try:
        yield process
    finally:
        if process.poll() not in (None, 0):
            # Process terminated with an error
            raise RuntimeError(f'Command &quot;{cmdline}&quot; terminated with error: {process.returncode}')

        # The process returned by subprocess.Popen is the shell process, not the
        # ROS process. Terminating the former will not necessarily terminate the latter.
        # Terminate all the *children* of the shell process instead.
        children = shellproc.children()
        assert len(children) &lt;= 1
        if children:
            rosproc = children[0]
            rosproc.terminate()


@contextlib.contextmanager
def roudi_daemon(env=os.environ, roudi_config_path=None):
    &quot;&quot;&quot;
    Context manager that runs a RouDi instance for the duration of the context.

    The `env` parameter specifies environment variables for the RouDi process.
    The `roudi_config_path` parameter can be used to provide a RouDi toml configuration file.
    &quot;&quot;&quot;
    if 'ICEORYX_HOME' not in env:
        raise RuntimeError('Cannot find ICEORYX_HOME in environment. ' +
                           'Is the iceoryx environment set up?')
    try:
        with open('/tmp/roudi.lock') as roudi_lock:
            try:
                fcntl.flock(roudi_lock.fileno(), fcntl.LOCK_EX | fcntl.LOCK_NB)
            except BlockingIOError as exception:
                raise RuntimeError('RouDi already running.') from exception
            finally:
                fcntl.flock(roudi_lock.fileno(), fcntl.LOCK_UN)
    except FileNotFoundError:
        pass  # If the file does not exist, everything is fine; roudi is not running.

    roudi_shell = subprocess.Popen(('$ICEORYX_HOME/bin/iox-roudi ' +
                                    ('' if roudi_config_path is None
                                     else f&quot;-c '{roudi_config_path}'&quot;)),
                                   shell=True,
                                   stdout=subprocess.PIPE,
                                   stderr=subprocess.PIPE,
                                   env=env)

    try:
        yield roudi_shell
    finally:
        if roudi_shell.poll() is not None:
            raise RuntimeError(f'Roudi terminated with return code {roudi_shell.returncode}:\n' +
                               f'Output: {roudi_shell.stderr.read()}')

        roudi_process, = psutil.Process(roudi_shell.pid).children()
        roudi_process.terminate()
        roudi_process.wait()


def generate_callback_trace(executable, pkg, directory, runtime_sec, rmw):
    &quot;&quot;&quot;
    Generate a tracefile for the given executable using the 'callback' method.

    The 'callback' method measures the executable using 'ros2 trace'
    &quot;&quot;&quot;
    raise NotImplementedError('lttng currently does not work within ADE')

    if not tracetools_available:
        raise RuntimeError('Unable to import tracetools_trace. Are the tracetools installed?')

    log_directory = get_benchmark_directory(directory, executable, runtime_sec, rmw, create=True)

    kernel_events = []
    user_events = DEFAULT_EVENTS_ROS
    session = f'callback_trace_{pkg}_{executable}_{rmw}_{runtime_sec}s'
    tracer = subprocess.Popen(f'ros2 trace -s {session} ' +
                              f'-p {log_directory/&quot;callback_trace&quot;} ' +
                              f'-k {&quot; &quot;.join(kernel_events)} ' +
                              f'-u {&quot; &quot;.join(user_events)} ',
                              shell=True,
                              text=True,
                              stdin=subprocess.PIPE)
    try:
        with terminatingRos2Run(pkg, executable, rmw,
                                stdout=subprocess.DEVNULL):
            # transmit the key press that ros2 trace requires to start
            tracer.stdin.write('\n')
            time.sleep(runtime_sec)
    finally:
        tracer.terminate()


def generate_std_trace(executable, pkg, directory, runtime_sec, rmw):
    &quot;&quot;&quot;
    Generate a tracefile for the given executable using the 'std' method.

    The 'std' method logs stdout of the executable.
    &quot;&quot;&quot;
    log_directory = get_benchmark_directory(directory, executable, runtime_sec, rmw, create=True)

    logfile = log_directory/'std_output.log'
    with logfile.open('w', encoding='utf8') as logfd:
        with terminatingRos2Run(pkg, executable, rmw,
                                stdout=logfd,
                                text=True):
            time.sleep(runtime_sec)


def generate_memory_trace(executable, pkg, directory, runtime_sec, rmw):
    &quot;&quot;&quot;
    Generate a tracefile for the given executable using the 'memory' method.

    The 'memory' method uses `psrecord` to profile memory and CPU usage.
    &quot;&quot;&quot;
    log_directory = get_benchmark_directory(directory, executable, runtime_sec, rmw, create=True)
    logfile = log_directory/f'memory_log.txt'
    plotfile = log_directory/f'memory_log.png'

    psrecord_cmd = subprocess.run('command -v psrecord', shell=True, stdout=subprocess.DEVNULL)
    if psrecord_cmd.returncode != 0:
        raise RuntimeError('psrecord is not installed; install it with pip install -U psrecord')

    with terminatingRos2Run(pkg, executable, rmw,
                            stdout=subprocess.DEVNULL) as rosprocess:
        # Note: psrecord does provide a duration argument, but it just kills its subprocess
        #       using SIGKILL, which does not reliably terminate ROS programs.
        #       We therefore run psrecord inside the terminatingRos2Run instead.
        tracerprocess = subprocess.Popen(f'psrecord --include-children ' +
                                         f'--log {logfile} ' +
                                         f'--plot {plotfile} ' +
                                         f'{rosprocess.pid} ',
                                         shell=True)

        time.sleep(runtime_sec+0.5)
    tracerprocess.wait(20)


def generate_trace(trace_type, *args, **kwargs):
    if trace_type == 'memory':
        return generate_memory_trace(*args, **kwargs)
    elif trace_type == 'callback':
        return generate_callback_trace(*args, **kwargs)
    elif trace_type == 'std':
        return generate_std_trace(*args, **kwargs)
    else:
        raise ValueError(f'Invalid trace_type: {trace_type}')


def generate_callback_report(executable, pkg, directory, runtime_sec, rmw):
    &quot;&quot;&quot;Generate a per-executable report from the 'callback' trace file.&quot;&quot;&quot;
    if not tracetools_available:
        raise RuntimeError('Unable to import tracetools_trace. Are the tracetools installed?')

    log_directory = get_benchmark_directory(directory, executable, runtime_sec, rmw)
    duration_output = log_directory/'callback_duration_report.html'
    dropped_msgs_output = log_directory/'tracing_latency_and_dropped_messages_report.html'
    data_model = initDataModel(log_directory/'callback_trace')

    bokeh_output_file(filename=duration_output,
                      title='Callback Duration Report')
    print('Output report to', duration_output)
    duration_summary = callback_duration.summary(
        data_model=data_model,
        size=SIZE_SUMMARY)
    duration_individual = callback_duration.individual(
        data_model=data_model,
        size=SIZE_SUBPLOT)
    report = bokeh_layout([[duration_summary], *duration_individual])
    bokeh_save(report)

    bokeh_output_file(filename=dropped_msgs_output,
                      title='ROS 2 Tracing Latency and Dropped Messages Report')
    print('Output report to', dropped_msgs_output)
    dropped_msgs = dropped_messages.individual(
        data_model=data_model,
        size=SIZE_SUMMARY)
    report = bokeh_layout([[dropped_msgs]])
    bokeh_save(report)


def generate_memory_report(executable, pkg, directory, runtime_sec, rmw):
    &quot;&quot;&quot;Generate a per-executable report from the 'memory' trace file.&quot;&quot;&quot;
    log_directory = get_benchmark_directory(directory, executable, runtime_sec, rmw)
    output = log_directory/'memory_and_cpu_usage_report.html'
    input_path = log_directory/'memory_log.txt'

    bokeh_output_file(filename=output,
                      title='Memory and CPU Usage Report')
    print('Output report to', output)
    mem_individual = memory_usage.individual(input_path,
                                             size=SIZE_SUMMARY)
    report = bokeh_layout([*mem_individual])
    bokeh_save(report)


def generate_report(trace_type, *args, **kwargs):
    if trace_type == 'memory':
        return generate_memory_report(*args, **kwargs)
    elif trace_type == 'callback':
        return generate_callback_report(*args, **kwargs)
    elif trace_type == 'std':
        return None  # No postprocessing needed for std trace
    else:
        raise ValueError(f'Invalid trace_type: {trace_type}')


def generate_summary_report(trace_type, pkg, directory, runtime_sec):
    &quot;&quot;&quot;Generate a summary report for the given `trace_type`, using all traces under `directory`.&quot;&quot;&quot;
    trace_dirs = get_benchmark_directories_below(directory, runtime_sec=runtime_sec)
    if trace_type == 'memory':
        output_file = f'{directory}/memory_and_cpu_usage_summary_report_{runtime_sec}s.html'
        bokeh_output_file(filename=output_file,
                          title='Memory Usage Report')

        mem_summary = memory_usage.summary_from_directories(trace_dirs,
                                                            duration=runtime_sec,
                                                            size=SIZE_SUMMARY)
        report = bokeh_layout([*mem_summary])

    elif trace_type == 'std':
        output_file = f'{directory}/executor_kpi_summary_report_{runtime_sec}s.html'
        bokeh_output_file(filename=output_file,
                          title='Executor Key Performance Indicator (KPI) Report')

        std_summary = std_latency.summary_from_directories(trace_dirs,
                                                           duration=runtime_sec,
                                                           size=SIZE_SUMMARY)
        report = bokeh_layout([*std_summary])
    else:
        raise NotImplementedError(f'Unsupported trace type {trace_type}')

    print('Output report to', output_file)
    bokeh_save(report)


def setup_benchmark_directory(pkg, create=False):
    base_dir = ROS_HOME/f'benchmark_{pkg}'
    if not create:
        latest = base_dir/'latest'
        if not latest.exists():
            raise FileNotFoundError(f'Benchmark directory {base_dir} does not exist')
        return latest

    base_dir.mkdir(exist_ok=True, parents=True)
    # Create a subdirectory with a timestamp and link 'latest' to it.
    timestamp = time.strftime('%Y-%m-%d-%H-%M-%S')
    benchmark_dir = base_dir/timestamp
    latest_symlink = base_dir/'latest'
    latest_symlink.unlink(missing_ok=True)
    latest_symlink.symlink_to(benchmark_dir)
    return benchmark_dir
</code></pre>
<hr />
<p>Updated on 2022-04-30 at 21:32:33 +0000</p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
    
  </body>
</html>